<section>

<h1>ãµã¤ã†ã® print debug é›†</h1>
<h3><a href="https://github.com/284km" class="user-mention">@284km</a></h3>
<h5>è¡¨å‚é“.rb #22 ~ãƒ­ã‚®ãƒ³ã‚°ã€ãƒ‡ãƒãƒƒã‚°~</h5>

<p><img src="../goku.jpg" alt="goku.jpg"></p>

</section>
<section>

<h1>self.inspect</h1>

<ul>
  <li><a href="https://github.com/284km" class="user-mention">@284km</a></li>
  <li>feedforce
    <ul>
      <li>Ruby/Rails ä¸­å¿ƒã®ç”Ÿæ´»</li>
    </ul>
  </li>
</ul>

</section>
<section>

<h1>æœ¬é¡Œ</h1>

<ul>
  <li>ãƒ­ã‚®ãƒ³ã‚°</li>
  <li>ãƒ‡ãƒãƒƒã‚°</li>
</ul>

</section>
<section>

<h1>ãƒ‡ãƒãƒƒã‚°</h1>

</section>
<section>

<h1>ãƒ‡ãƒãƒƒã‚°ã®åœ°å‘³ãªè©±ã‚’ã—ã¾ã™</h1>

</section>
<section>

<h1>ã‚ˆãä½¿ã†</h1>

<ul>
  <li>binding.pry</li>
  <li>print debug</li>
</ul>

</section>
<section>

<h1>print debug</h1>

<p>æ‰‹è»½ã«è©¦ã›ã‚‹ã€‚ã“ã‚Œã§æ¸ˆã‚ã°ã†ã‚Œã—ã„ğŸ˜‡</p>

<p>çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ã¯ã„ã‘ãªã„ã€‚ç”¨æ³•ã«æ³¨æ„ã€‚</p>

</section>
<section>

<h1>print debug</h1>

<pre><code class="language-.rb"># ã“ã†ã„ã†ã‚„ã¤
puts "#" * 80
puts foo
puts "#" * 80

if foo == 1
  bar = 10
else
  bar = 20
end
</code></pre>

</section>
<section>

<h1>ä½•å‡¦ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ã‚‹ã‹çŸ¥ã‚ŠãŸã„æ™‚</h1>
<h1>Kernel.#caller</h1>

</section>
<section>

<h1>Kernel.#caller</h1>

<p>å‘¼ã³å‡ºã—å…ƒã®æƒ…å ±ã‚’ãƒãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹(æ–‡å­—åˆ—ã®é…åˆ—)ã¨ã—ã¦è¿”ã™</p>

<ul>
  <li>caller(0) # ç¾åœ¨ã®å ´æ‰€ã‹ã‚‰</li>
  <li>caller(1) # å‘¼ã³å‡ºã—å…ƒã‹ã‚‰(default)</li>
  <li>caller(2) # å‘¼ã³å‡ºã—å…ƒã®å‘¼ã³å‡ºã—å…ƒã‹ã‚‰</li>
</ul>

<pre><code>def f1
  f2
end

def f2
  f3
end

def f3
  p caller(0)  #=&gt; ["1.rb:10:in `f3'", "1.rb:6:in `f2'", "1.rb:2:in `f1'", "1.rb:15:in `&lt;main&gt;'"]
  p caller     #=&gt; ["1.rb:6:in `f2'", "1.rb:2:in `f1'", "1.rb:15:in `&lt;main&gt;'"]
  p caller(2)  #=&gt; ["1.rb:2:in `f1'", "1.rb:15:in `&lt;main&gt;'"]
end

f1
</code></pre>

</section>
<section>

<h2>ãƒ•ã‚¡ã‚¤ãƒ«å, è¡Œæ•°ä»˜ãã§å‡ºåŠ›ã—ãŸã‚Š</h2>

<pre><code>def debug_puts(message)
  caller()[0] =~ /(.*?):(\d+)/
  filename, linenum = $1, $2
  $stderr.puts "[DEBUG] #{filename}:#{linenum}"
  $stderr.puts "[DEBUG] #{message}"
end

x = "foo"
debug_puts "x=#{x.inspect}"
x = "bar"
debug_puts "x=#{x.inspect}"

#=&gt; [DEBUG] 2.rb:9
#=&gt; [DEBUG] x="foo"
#=&gt; [DEBUG] 2.rb:11
#=&gt; [DEBUG] x="bar"
</code></pre>

</section>
<section>

<h1>Excelption ã®ç™ºç”Ÿå…ƒã‚’çŸ¥ã‚ŠãŸã„ã¨ã</h1>

</section>
<section>

<h3>Exception ã®ç™ºç”Ÿå…ƒã‚’çŸ¥ã‚ŠãŸã„æ™‚</h3>
<ul>
  <li>Exception#backtrace()</li>
  <li>Exception#set_backtrace</li>
</ul>

<p>ä½•ã‚‰ã‹ã€å‘¼ã³å…ƒãŒçŸ¥ã‚ŠãŸã„æ™‚ã«ä½¿ãˆã‚‹â€¦<br>
(è‰¯ã„ä¾‹ãŒãƒ‘ãƒƒã¨æ€ã„ã¤ã‹ãªã‹ã£ãŸ<br>
ãƒ†ã‚¹ãƒˆãªã©ãŒãã†ã§ã™ï¼Ÿ</p>

<pre><code>class AssertionError &lt; StandardError
end

def debug_assert(expr)
  return if expr
  ex = AssertionError.new("assertion failed")
  ex.set_backtrace(caller())
  raise ex  # æœ¬å½“ã¯ã“ã“ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¦ã„ã‚‹
end

def f1
  debug_assert 1 + 1 == 3 #=&gt; ã“ã“ã§ç™ºç”Ÿã—ãŸã‚ˆã†ã«
end

f1()
# =&gt; 8.rb:12:in `f1': assertion failed (AssertionError)
# =&gt;         from example.rb:15:in `&lt;main&gt;'
</code></pre>

</section>
<section>

<h2>ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©å ´æ‰€ã‚’çŸ¥ã‚ŠãŸã„æ™‚</h2>
<h2>source_location</h2>

<p>pry ã‚‚ä¾¿åˆ©<br>
?: æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ã‚³ãƒ¡ãƒ³ãƒˆ)ã‚’è¡¨ç¤º<br>
$: æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¤º</p>

</section>
<section>

<h2>ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©å ´æ‰€ã‚’çŸ¥ã‚ŠãŸã„æ™‚</h2>
<h3>- Kernel#method</h3>
<h3>- Method#source_location</h3>

<p>Kernel#method ã¨ Method#source_location ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹</p>

<pre><code>$ rails c
Loading development environment (Rails 5.0.2)
[1] pry(main)&gt; 'x'.method(:blank?).source_location
=&gt; ["/Users/furuhashi/src/github.com/feedforce/ecbooster/vendor/bundle/ruby/2.4.0/gems/activesupport-5.0.2/lib/active_support/core_ext/object/blank.rb",
 114]
</code></pre>

</section>
<section>

<h2>super ã®å ´åˆ</h2>

<pre><code>class Super
  def foo
    "foo"
  end
end

class Sub &lt; Super
  def foo
    "foobar"
  end
end

x = Sub.new

x.method(:foo).super_method.call #=&gt; "foo"
x.method(:foo).super_method.source_location
#=&gt; example.rb
#=&gt; 2
</code></pre>

</section>
<section>

<h2>ObjectSpace.trace_object_allocations_start ã‚’ä½¿ã£ãŸã‚„ã‚Šæ–¹</h2>

<p>trace_object_allocations ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’å›²ã‚€ã‹ã€<br>
trace_object_allocations_start, trace_object_allocations_stop ã§å‡¦ç†ã‚’å›²ã‚€ã€‚</p>

<pre><code>require 'objspace'
ObjectSpace.trace_object_allocations_start
o = Object.new
ObjectSpace.trace_object_allocations_stop
puts ObjectSpace.allocation_sourcefile(o) #=&gt; "example.rb"
puts ObjectSpace.allocation_sourceline(o) #=&gt; 5
# trace ã—ãŸæƒ…å ±ã‚’ clear ã—ã¦ã¾ã™
ObjectSpace.trace_object_allocations_clear
</code></pre>

</section>
<section>

<h3>Kernel.#set_trace_func</h3>
<h3>ã§ãƒ•ãƒƒã‚¯ã—ã¦èª¿ã¹ã‚‹</h3>

<ul>
  <li>Ruby ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹</li>
  <li>Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ æŒ‡å®šã•ã‚ŒãŸ proc ã‚’ç™»éŒ²ã—ã¾ã™</li>
</ul>

<pre><code>class Foo
  def foo; bar; end
  def bar; end
end
class Bar &lt; Foo
  def bar; end
end

set_trace_func lambda { |event, file, line ,id, binding, klass|
  if event == 'call' &amp;&amp; id == :bar
    puts "call method bar file:#{file} line:#{line}"
  end
}

Foo.new.foo
Bar.new.foo
# =&gt; call method bar file:example.rb line:5
# =&gt; call method bar file:example.rb line:10
</code></pre>

</section>
